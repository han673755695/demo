<!DOCTYPE html>
<html class="x-admin-sm">
    <meta charset="UTF-8">
	<#include "../common/head.html"/>
	<@aHead title="后台登录-X-admin2.2" />
	<link rel="stylesheet" href="${base}/platform/zTree/css/zTreeStyle/zTreeStyle.css" type="text/css">
	<link rel="stylesheet" href="${base}/platform/zTree/css/demo.css" type="text/css">
	<script type="text/javascript" src="${base}/platform/zTree/js/jquery.ztree.core-3.5.js"></script>
	<script type="text/javascript" src="${base}/platform/zTree/js/jquery.ztree.excheck-3.5.js"></script>
	
	
    <body>
        <div class="x-nav">
            <span class="layui-breadcrumb">
                <a onclick="parent.xadmin.add_tab('桌面','${base}/admin/index/toWelcome')" style="color: red" href="javascript:;">桌面</a>
                <a href="">演示</a>
                <a>
                    <cite>导航元素</cite></a>
            </span>
            <a class="layui-btn layui-btn-small" style="line-height:1.6em;margin-top:3px;float:right" onclick="location.reload()" title="刷新">
                <i class="layui-icon layui-icon-refresh" style="line-height:30px"></i>
            </a>
        </div>
        <!-- 左边的菜单树 -->
        <div class="layui-fluid" style="float: left">
            <div class="layui-row layui-col-space15">
                <div class="layui-col-md12">
                    <div class="layui-card">
						<div class="layui-card-header">
							<button class="layui-btn" onclick="xadmin.open('添加菜单','${base}/admin/menu/toSaveMenu',800,600)">
	                                <i class="layui-icon"></i>添加
	                        </button>
                        </div>
						<div class="zTreeDemoBackground left">
							<ul id="listTree" class="ztree"></ul>
						</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 右边的详情 -->
        <div class="layui-fluid" style="float: left">
			<div class="layui-row">
				<form class="layui-form">
					<div class="layui-form-item">
						<label for="name" class="layui-form-label">
                            <span class="x-red">*</span>菜单名称</label>
						<div class="layui-input-inline">
							<input type="text" id="name" name="name" value="" required="" lay-verify="required" autocomplete="off" class="layui-input"/>
							<input type="hidden" id="id" name="id" value="" />
						</div>
					</div>
					<div class="layui-form-item">
						<label for="url" class="layui-form-label">
                            <span id="span" class="x-red"></span>url地址</label>
						<div class="layui-input-inline">
							<input type="text" id="url" name="url" value="" required="" lay-verify="" autocomplete="off" class="layui-input"></div>
					</div>
					
					<div class="layui-inline">
						<label class="layui-form-label">选择父菜单</label>
						
						<div class="layui-input-inline">
							<input type="text" id="citySel" placeholder="选择菜单" readonly required="" lay-verify="" autocomplete="off" class="layui-input" onclick="showMenu()">
							<input type="hidden" id="parentId" name="parentId"/>
						</div>
					</div>
					
					<div id="menuContent" class="menuContent" style="display:none; position: absolute; left: 126px; top: 137px; z-index: 5; background-color: rgb(255, 255, 253);">
						<ul id="treeDemo" class="ztree" style="margin-top:0; width:180px; height: 300px;"></ul>
					</div>
					
					
					
					<div class="layui-form-item">
		                <label class="layui-form-label"><span class="x-red">*</span>是否可用</label>
		                <div class="layui-input-block">
	                		<input type="radio" name="status" value="1" lay-skin="primary" title="是" >
		                	<input type="radio" name="status" value="2" lay-skin="primary" title="否" >
		                </div>
	                </div>
					<div class="layui-form-item">
						<label for="sort" class="layui-form-label">
                            <span class="x-red">*</span>排序</label>
						<div class="layui-input-inline">
							<input type="text" id="sort" value="" name="sort" required="" lay-verify="number" autocomplete="off" class="layui-input"></div>
					</div>
					<div class="layui-form-item">
						<label for="L_repass" class="layui-form-label"></label>
						<button class="layui-btn" lay-filter="add" id="sub" lay-submit="">提交</button>
						<button type="reset" class="layui-btn layui-btn-primary">重置</button>
					</div>
				</form>
			</div>
		</div>
        <script>
        	var form;
        	layui.use(['form', 'layer'],
				function() {
					$ = layui.jquery;
					form = layui.form;
					var layer = layui.layer;
					
					//监听提交
					form.on('submit(add)',
						function(dataJson) {
							$.ajax({
								type: "POST", //GET或POST,
								async:true, //默认设置为true，所有请求均为异步请求。
								url: "${base}/admin/menu/saveMenu",
								data: dataJson.field,
								dataType: "json", //xml、html、script、jsonp、text
								success: function(dataResult) {
									if(dataResult && dataResult.status == 'success'){
										layer.alert("操作成功", {icon: 6},function() {
											//关闭当前frame
											xadmin.close();
											// 可以对父窗口进行刷新 
											xadmin.father_reload();
										});
									}else{
										layer.alert('保存失败555', {icon: 5});
									}
								},
								error:function(){
									layer.alert('保存失败6666', {icon: 5});
								}
							});
							return false;
						});

				});
		</script>
		
		<script type="text/javascript">
			var setting = {
				check: {
					enable: true,
					chkStyle: "radio",
	                radioType: "all"
				},
				view: {
					dblClickExpand: false
				},
				data: {
					simpleData: {
						enable: true
					}
				},
				callback: {
					onCheck: onRightCheck
				}
			};
	
			var zNodes =[
				
			 ];
			
			<#if (resultdata??) && (resultdata?size>0)>
		    	<#list resultdata.data as menu>
			    	var node = {};
			    	var url = "${(menu.url)!''}";
			    	if(!url){
			    		node.id = "${(menu.id)!''}";
						node.pId = "${(menu.parentId)!''}";
						node.name = "${(menu.name)!''}";
						node.open = true;
			    	} else {
						node.id = "${(menu.id)!''}";
						node.pId = "${(menu.parentId)!''}";
						node.name = "${(menu.name)!''}";
					}
					zNodes.push(node);
		    	</#list>
		    </#if>
			
			
			function onRightCheck(e, treeId, treeNode) {
				var cityObj = $("#citySel");
				cityObj.val(treeNode.name);
				$("#parentId").val(treeNode.id);
			}
	
			function showMenu() {
				$("#menuContent").slideDown("fast");
				$("body").bind("mousedown", onBodyDown);
			}
			function hideMenu() {
				$("#menuContent").fadeOut("fast");
				$("body").unbind("mousedown", onBodyDown);
			}
			function onBodyDown(event) {
				if (!(event.target.id == "menuBtn" || event.target.id == "citySel" || event.target.id == "menuContent" || $(event.target).parents("#menuContent").length>0)) {
					hideMenu();
				}
			}
	
			$(document).ready(function(){
				$.fn.zTree.init($("#treeDemo"), setting, zNodes);
			});
		</script>
        
        
        
        
        
        
    </body>
    <script>layui.use(['laydate', 'form'],
        function() {
            var laydate = layui.laydate;

          	//执行一个laydate实例
			laydate.render({
				elem: '#start', //指定元素
				type: 'date',
				format: 'yyyy-MM-dd',
				max: new Date().format("yyyy-MM-dd"),
				range: '~'
			});
        });


        /*单个删除*/
        function member_del(obj, id) {
            layer.confirm('确认要删除吗？',
            function(index) {
                
            	$.ajax({
					type: "POST", //GET或POST,
					async:true, //默认设置为true，所有请求均为异步请求。
					url: "${base}/admin/menu/delMenu",
					data: {ids:id},
					dataType: "json", //xml、html、script、jsonp、text
					success: function(dataResult) {
						if(dataResult && dataResult.status == 'success'){
							$(obj).parents("tr").remove();
							layer.msg('已删除!', {
								icon: 1,
								time: 1000
							});
						}else{
							layer.alert('操作失败', {icon: 5});
						}
					},
					error:function(){
						layer.alert('操作失败', {icon: 5});
					},
				});
            });
        }

		
		function changeTab(){
			element.tabChange('xbs_tab', '038a139703cac67ae15708a9b6bd3f85');
		}
        
     </script>
     
	
	
	<script type="text/javascript">
		/* 列表树 */
		var listSetting = {
			/* check: {
				enable: true,
				chkStyle: "radio",
                radioType: "all"
			}, */
			view: {
				showLine: false
			},
			data: {
				simpleData: {
					enable: true
				}
			},
			callback: {
				onCheck: onLiftCheck
			}
		};
		
		function onCheck(e, treeId, treeNode) {
			
			console.log("ids: " + treeNode);
		}

		var listZNodes =[
			
		];
		
		
		<#if (resultdata??) && (resultdata?size>0)>
	    	<#list resultdata.data as menu>
		    	var node = {};
		    	var url = "${(menu.url)!''}";
		    	if(!url){
		    		node.id = "${(menu.id)!''}";
					node.pId = "${(menu.parentId)!''}";
					node.name = "${(menu.name)!''}";
					node.click = "onLiftCheck(\'" + node.id + "\')";
					node.open = true;
		    	} else {
					node.id = "${(menu.id)!''}";
					node.pId = "${(menu.parentId)!''}";
					node.name = "${(menu.name)!''}";
					node.click = "onLiftCheck(\'" + node.id + "\')";
				}
		    	listZNodes.push(node);
	    	</#list>
	    </#if>
		
	    
	    function onLiftCheck(id){
	    	console.log("id:" + id);
	    	queryDetailAjax(id);
	    }
	    
	    /* 获取详细信息ajax方法 */
		function queryDetailAjax(id){
			$.ajax({
				type: "POST", //GET或POST,
				async:true, //默认设置为true，所有请求均为异步请求。
				url: "${base}/admin/menu/menuEdit/json",
				data: {
					id: id
				},
				dataType: "json", //xml、html、script、jsonp、text
				success: function(dataResult) {
					if(dataResult && dataResult.status == 'success'){
						console.log("dataResult: " + JSON.stringify(dataResult))
						var menu = dataResult.data;
						$("#name").val(menu.name);
						$("#id").val(menu.id);
						$("#url").val(menu.url);
						$("#parentId").val(menu.parentId);
						$("#sort").val(menu.sort);
						var pName = dataResult.mapData.parentName;
						if(pName){
							$("#citySel").val(pName);
						}else{
							$("#citySel").val("");
						}
						
						$("input[name='status']").each(function(index,ele){
							if($(ele).val() == menu.status){
								$(ele).attr("checked","checked");
								form.render('radio')
							}
						})
						
					}else{
						layer.alert('操作失败', {icon: 5});
					}
				},
				error:function(){
					layer.alert('操作失败', {icon: 5});
				},
			});
		}

		$(document).ready(function(){
			$.fn.zTree.init($("#listTree"), listSetting, listZNodes);
		});
	
	</script>
	

</html>